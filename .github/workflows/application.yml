---
name: Application
on:
  workflow_call:
    inputs:
      jobname:
        type: string
        required: false
        description: 'A jobname passed from the caller workflow'
        default: 'application'
  pull_request:
    paths:
    # Tool
    - '.aqua.yaml'
    # Coverage
    - '.octocov.yml'
    # GitHub Actions
    - '.github/actions/setup-go/action.yaml'
    - '.github/actions/setup-aqua/action.yaml'
    - '.github/workflows/application.yml'
    # Task
    - 'Taskfile.yml'
    - 'tasks/**.task.yml'
    # Go
    - '**.go'
    - 'go.mod'
    - 'go.sum'
permissions:
  contents: write
  pull-requests: write
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || inputs.jobname }}
  cancel-in-progress: true
jobs:
  ################################################################################
  # Go Testing
  ################################################################################
  test:
    name: Go Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    ################################################################################
    # Checkout
    ################################################################################
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: ${{ startsWith(github.ref, 'refs/tags/') && '0' || '1' }}
    ################################################################################
    # Setup Aqua
    ################################################################################
    - name: Setup Aqua
      uses: ./.github/actions/setup-aqua
      with:
        go-cache: true
    ################################################################################
    # Go
    ################################################################################
    - name: Go Mod
      run: task app:mod
    - name: Go Test
      run: task app:test
    ################################################################################
    # Coverage
    ################################################################################
    - name: Coverage (octocov)
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          toolpath = await io.which('octocov', true)
          await exec.exec(`${toolpath}`)
      env:
        OCTOCOV_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ################################################################################
  # Status Check
  ################################################################################
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions: {}
    if: always()
    needs:
    - test
    steps:
    - name: Status Ok
      if: success()
      run: exit 0
    - name: Status Ok
      if: cancelled() || failure()
      run: exit 1
